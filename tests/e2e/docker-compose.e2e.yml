services:
  # Monolith stack
  mongo-monolith:
    image: mongo:latest

  monolith:
    build:
      dockerfile: tests/e2e/Dockerfile.monolith
      context: ../..
    depends_on:
      - mongo-monolith
    environment:
      MONGO_URL: 'mongodb://mongo-monolith:27017'
      VITE_CHANGENOTIFIER_URL: 'http://monolith:53008'
      SVELTE_HOST: '0.0.0.0'
      LOG_LEVEL: 'warn'

  # Orchestrated stack
  mongo:
    image: mongo:latest

  rabbit:
    image: rabbitmq:latest

  command-processor:
    build:
      dockerfile: packages/orchestrated/command-processor/Dockerfile
      context: ../..
    depends_on:
      - mongo
      - rabbit
    environment:
      EXPRESS_PORT: '80'
      MONGO_URL: 'mongodb://mongo:27017'
      RABBIT_URL: 'amqp://rabbit'
      LOG_LEVEL: 'warn'

  readmodel-customers:
    build:
      dockerfile: packages/orchestrated/readmodel-customers/Dockerfile
      context: ../..
    depends_on:
      - mongo
      - rabbit
      - change-notifier
    environment:
      EXPRESS_PORT: '80'
      MONGO_URL: 'mongodb://mongo:27017'
      MONGO_DATABASE: 'readmodel-customers'
      RABBIT_URL: 'amqp://rabbit'
      CHANGENOTIFICATION_FETCH_URL: 'http://change-notifier/change'
      COMMAND_URL: 'http://command-processor/api/command'
      LOG_LEVEL: 'warn'

  readmodel-orders:
    build:
      dockerfile: packages/orchestrated/readmodel-orders/Dockerfile
      context: ../..
    depends_on:
      - mongo
      - rabbit
      - change-notifier
    environment:
      EXPRESS_PORT: '80'
      MONGO_URL: 'mongodb://mongo:27017'
      MONGO_DATABASE: 'readmodel-orders'
      RABBIT_URL: 'amqp://rabbit'
      CHANGENOTIFICATION_FETCH_URL: 'http://change-notifier/change'
      COMMAND_URL: 'http://command-processor/api/command'
      LOG_LEVEL: 'warn'

  change-notifier:
    build:
      dockerfile: packages/orchestrated/change-notifier/Dockerfile
      context: ../..
    environment:
      EXPRESS_PORT: '80'
      LOG_LEVEL: 'warn'

  frontend-svelte:
    build:
      dockerfile: packages/orchestrated/frontend-svelte/Dockerfile
      context: ../..
    depends_on:
      - command-processor
      - readmodel-customers
      - readmodel-orders
      - change-notifier
    environment:
      VITE_RM_CUSTOMERS_URL: 'http://readmodel-customers'
      VITE_RM_ORDERS_URL: 'http://readmodel-orders'
      VITE_COMMAND_URL: 'http://command-processor/api/command'
      VITE_CHANGENOTIFIER_URL: 'http://change-notifier'

  frontend-react:
    build:
      dockerfile: packages/orchestrated/frontend-react/Dockerfile
      context: ../..
    depends_on:
      - command-processor
      - readmodel-customers
      - readmodel-orders
      - change-notifier
    environment:
      VITE_RM_CUSTOMERS_URL: 'http://readmodel-customers'
      VITE_RM_ORDERS_URL: 'http://readmodel-orders'
      VITE_COMMAND_URL: 'http://command-processor/api/command'
      VITE_CHANGENOTIFIER_URL: 'http://change-notifier'

  # Playwright test runner
  playwright:
    build: .
    depends_on:
      - monolith
      - frontend-svelte
      - frontend-react
    ipc: host
    environment:
      CI: 'true'
