services:
  # Monolith stack
  mongo-monolith:
    image: mongo:latest

  monolith:
    build:
      dockerfile: tests/e2e/Dockerfile.monolith
      context: ../..
    depends_on:
      - mongo-monolith
    environment:
      MONGO_URL: 'mongodb://mongo-monolith:27017'
      VITE_CHANGENOTIFIER_URL: 'http://monolith:53008'
      SVELTE_HOST: '0.0.0.0'
      LOG_LEVEL: 'warn'

  # Orchestrated stack
  mongo:
    image: mongo:latest

  rabbit:
    image: rabbitmq:latest

  vault:
    image: hashicorp/vault:latest
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: 'dev-root-token'
      VAULT_DEV_LISTEN_ADDRESS: '0.0.0.0:8200'
    healthcheck:
      test: ['CMD', 'vault', 'status']
      interval: 5s
      timeout: 3s
      retries: 10

  vault-init:
    image: hashicorp/vault:latest
    depends_on:
      vault:
        condition: service_healthy
    environment:
      VAULT_ADDR: 'http://vault:8200'
      VAULT_TOKEN: 'dev-root-token'
    entrypoint: /bin/sh
    command: ['/vault-init.sh']
    volumes:
      - ../../packages/orchestrated/vault-init.sh:/vault-init.sh:ro
    restart: 'no'

  command-processor:
    build:
      context: ../../packages/orchestrated
      dockerfile: command-processor/Dockerfile
    depends_on:
      mongo:
        condition: service_started
      rabbit:
        condition: service_started
      vault-init:
        condition: service_completed_successfully
    environment:
      EXPRESS_PORT: '80'
      MONGO_URL: 'mongodb://mongo:27017'
      RABBIT_URL: 'amqp://rabbit'
      LOG_LEVEL: 'warn'
      VAULT_ADDR: 'http://vault:8200'
      VAULT_ROLE_ID: 'command-processor-role-id'
      VAULT_SECRET_ID: 'command-processor-secret-id'

  readmodel-customers:
    build:
      context: ../../packages/orchestrated
      dockerfile: readmodel-customers/Dockerfile
    depends_on:
      mongo:
        condition: service_started
      rabbit:
        condition: service_started
      change-notifier:
        condition: service_started
      vault-init:
        condition: service_completed_successfully
    environment:
      EXPRESS_PORT: '80'
      MONGO_URL: 'mongodb://mongo:27017'
      MONGO_DATABASE: 'readmodel-customers'
      RABBIT_URL: 'amqp://rabbit'
      CHANGENOTIFICATION_FETCH_URL: 'http://change-notifier/change'
      COMMAND_URL: 'http://command-processor/api/command'
      LOG_LEVEL: 'warn'
      VAULT_ADDR: 'http://vault:8200'
      VAULT_ROLE_ID: 'readmodel-customers-role-id'
      VAULT_SECRET_ID: 'readmodel-customers-secret-id'

  readmodel-orders:
    build:
      context: ../../packages/orchestrated
      dockerfile: readmodel-orders/Dockerfile
    depends_on:
      mongo:
        condition: service_started
      rabbit:
        condition: service_started
      change-notifier:
        condition: service_started
      vault-init:
        condition: service_completed_successfully
    environment:
      EXPRESS_PORT: '80'
      MONGO_URL: 'mongodb://mongo:27017'
      MONGO_DATABASE: 'readmodel-orders'
      RABBIT_URL: 'amqp://rabbit'
      CHANGENOTIFICATION_FETCH_URL: 'http://change-notifier/change'
      COMMAND_URL: 'http://command-processor/api/command'
      LOG_LEVEL: 'warn'
      VAULT_ADDR: 'http://vault:8200'
      VAULT_ROLE_ID: 'readmodel-orders-role-id'
      VAULT_SECRET_ID: 'readmodel-orders-secret-id'

  change-notifier:
    build: ../../packages/orchestrated/change-notifier
    environment:
      EXPRESS_PORT: '80'
      LOG_LEVEL: 'warn'

  frontend-svelte:
    build: ../../packages/orchestrated/frontend-svelte
    depends_on:
      - command-processor
      - readmodel-customers
      - readmodel-orders
      - change-notifier
    environment:
      VITE_RM_CUSTOMERS_URL: 'http://readmodel-customers'
      VITE_RM_ORDERS_URL: 'http://readmodel-orders'
      VITE_COMMAND_URL: 'http://command-processor/api/command'
      VITE_CHANGENOTIFIER_URL: 'http://change-notifier'

  frontend-react:
    build: ../../packages/orchestrated/frontend-react
    depends_on:
      - command-processor
      - readmodel-customers
      - readmodel-orders
      - change-notifier
    environment:
      VITE_RM_CUSTOMERS_URL: 'http://readmodel-customers'
      VITE_RM_ORDERS_URL: 'http://readmodel-orders'
      VITE_COMMAND_URL: 'http://command-processor/api/command'
      VITE_CHANGENOTIFIER_URL: 'http://change-notifier'

  # Playwright test runner
  playwright:
    build: .
    depends_on:
      - monolith
      - frontend-svelte
      - frontend-react
    ipc: host
    environment:
      CI: 'true'
